{{- if .Values.traefik.ingressRoute.dashboard.enabled -}}
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: {{ template "traefik.fullname" . }}-dashboard
  annotations:
    helm.sh/hook: "post-install,post-upgrade"
    {{- with .Values.traefik.ingressRoute.dashboard.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  labels:
    {{- include "gateway.labels" . | nindent 4 }}
    {{- with .Values.traefik.ingressRoute.dashboard.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  entryPoints:
    - traefik
  routes:
  {{- if .Values.tls.domain }}
  - match: (PathPrefix(`/dashboard`) || PathPrefix(`/api`) || PathPrefix(`/`)) && Host(`dashboard.{{ .Values.tls.domain }}`)
  {{- else }}
  - match: PathPrefix(`/dashboard`) || PathPrefix(`/api`) || PathPrefix(`/`)
  {{- end }}
    {{- if and .Values.traefik.ingressRoute.dashboard.id .Values.traefik.ingressRoute.dashboard.password }}
    middlewares:
    - name: {{ .Release.Namespace}}-dashboard-auth@kubernetescrd
    {{- end }}
    kind: Rule
    services:
    - name: api@internal
      kind: TraefikService
  tls: {}

{{- end -}}

{{- if and .Values.traefik.ingressRoute.dashboard.id .Values.traefik.ingressRoute.dashboard.password }}
---
# Declaring the user list
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: dashboard-auth
  annotations:
    helm.sh/hook: "post-install,post-upgrade"
    {{- with .Values.traefik.ingressRoute.dashboard.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  labels:
    {{- include "gateway.labels" . | nindent 4 }}
    {{- with .Values.traefik.ingressRoute.dashboard.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  basicAuth:
    secret: authsecret

---
# This is an alternate auth secret that demonstrates the basic-auth secret type.
# Note: the password is not hashed, and is merely base64 encoded.
apiVersion: v1
kind: Secret
metadata:
  name: authsecret
  annotations:
    helm.sh/hook: "post-install,post-upgrade"
    {{- with .Values.traefik.ingressRoute.dashboard.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  labels:
    {{- include "gateway.labels" . | nindent 4 }}
    {{- with .Values.traefik.ingressRoute.dashboard.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
type: kubernetes.io/basic-auth
data:
  username: {{ .Values.traefik.ingressRoute.dashboard.id | b64enc }}
  password: {{ .Values.traefik.ingressRoute.dashboard.password | b64enc }}
{{- end }}